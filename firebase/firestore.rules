rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function hasRole(request, role) {
      return (request.auth.token.roles is list && request.auth.token.roles.hasAny([role]))
          || (request.auth.token[role] == true);
    }

    function isAuthed(request) {
      return request.auth != null;
    }

    // Alunos - leitura pública para alunos ativos, escrita apenas para autenticados
    match /students/{docId} {
      allow read: if true; // Permite leitura pública
      allow create, update, delete: if isAuthed(request) && (hasRole(request, 'admin') || hasRole(request, 'professor'));
    }

    // Usuários (se utilizar essa coleção futuramente)
    match /users/{uid} {
      allow read: if isAuthed(request) && (request.auth.uid == uid || hasRole(request, 'admin'));
      allow write: if hasRole(request, 'admin');
    }

    // Templates de Checklist - leitura pública, escrita apenas para admins
    match /checklist_templates/{templateId} {
      allow read: if true; // Permite leitura pública para que usuários não logados possam ver as avaliações
      allow create, update, delete: if isAuthed(request) && hasRole(request, 'admin');
    }

    // Checklists dos Alunos - leitura pública, escrita apenas para professores/admins
    match /student_checklists/{checklistId} {
      allow read: if true; // Permite leitura pública para que usuários não logados possam ver as avaliações
      allow create, update, delete: if isAuthed(request) && (hasRole(request, 'admin') || hasRole(request, 'professor'));
    }
  }
}
